# compose-recipes/nextcloud

A secure Nextcloud setup using MariaDB and Redis. HTTPS support is handled by the Traefik reverse proxy.


## Prerequisites

* Two domain name entries:
    * One for the instance (e.g. `nc.example.tld`)
    * One for the Traefik proxy (e.g. `proxy.example.tld`). Not required, but useful for debugging.
* A SSL certificate with its private key.
    * The setup was validated with a certificate issued by a trusted root CA, but it should work correctly with a self-signed certificate.
    * For automated certificates definitions using [Let's Encrypt](https://letsencrypt.org/), there are many examples in the 'References' section.

## How to Run

1. Copy the environment file `.env.sample` to another file, such as `.env` or `.env.prod`. 

2. Open and tweak the environment file.
    * The value for `TRAEFIK_AUTH` must be generated by `htpasswd`. There are many generators online, but the safest way to generate an entry is by using `htpasswd` on your computer:

    ```sh
    # Will be prompted for the password.
    htpasswd -nB admin
    
    # The password provided on the command line will be used.
    htpasswd -nbB admin password
    ```

3. Add the used-defined certificate files to `traefik/certs' folder.
    1. Copy a valid SSL certificate and private key to the `traefik/certs` folder. Wildcard certificates are accepted.
    2. Open `traefik/config/tls.yaml` and change the paths to point to the certificate and private key.
        * Keep the starting slash (e.g. `/certs/MYCERT.crt`); this is the full path to the file(s) in the volume used by the Traefik container.

4. Run `docker-compose` or `podman-compose`:
```sh
docker-compose --env-file .env.prod up -d 
```

5. Open your favorite browser and go to `https://nc.example.tld`.

## Configuration
Some post-installation configuration is required for optimal performance.

1. Log in with the admin account, then go to _Administration Settings_. 
2. Under the _Administration_ section :
    * Select _Overview_ and ensure there are no errors in the _Security and setup warnings_ section.
    * Go to _Basic settings_. 
        1. In the _Background jobs_ section, select **Cron (Recommended)**.
        2. (optional) In the _Email server_ section fill out the requested information.
            * Not required for a private/local setup.

## Notes and Caveats
* The environment file contains usernames and passwords in clear text. 
    * They can be cleared after the first run.
* `traefik/config/tls.yaml` must be modified.
    * [According to the Traefik documentation](https://doc.traefik.io/traefik/https/tls/), the file provider is the only way to change these definitions. They cannot be set up as Docker labels, and thus being provided by the environment file.
* Accessing the Traefik dashboard requires an additional domain name.
    * A path prefix can be used instead, but debugging the reverse proxy is _far_ easier when a FQDN is used.

## References
* https://techviewleo.com/run-nextcloud-on-containers-using-podman/
* https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#Traefik_2_Docker_Compose
* https://spad.uk/practical-configuration-of-traefik-as-a-reverse-proxy-for-docker/
* https://accesto.com/blog/docker-reverse-proxy-using-traefik/
* http://day-to-day-stuff.blogspot.com/2020/04/traefik-v2-enable-hsts-docker-and.html
* https://doc.traefik.io/traefik/routing/services/#load-balancing
* https://doc.traefik.io/traefik/https/tls/
